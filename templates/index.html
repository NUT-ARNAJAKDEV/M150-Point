<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แต้มเอ็ม</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="container">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="แต้มเอ็ม" class="logo">
        <div class="points-card">
            <span class="points-label">แต้มทั้งหมดของคุณ</span>
            <span class="points-value" id="points-counter">0 แต้ม</span>
        </div>

        <div class="card">
            <p class="title">กรอกรหัสแล้ว ไม่ต้องเก็บฝาไว้!</p>
            <img src="{{ url_for('static', filename='code_sample.png') }}" alt="ตัวอย่างรหัส" class="code-image">

            <button class="capture-button">
                <img src="{{ url_for('static', filename='camera_icon.png') }}" alt="ถ่ายรูป" class="camera-icon">
                ถ่ายรูปใต้ฝาเพื่อสะสมแต้ม
            </button>

            <div class="input-group">
                <label>รหัสที่ 1</label>
                <div class="input-wrapper">
                    <input type="text" placeholder="ช่องกรอกรหัสที่ 1" class="code-input">
                    <span class="icon camera-trigger" data-input="code-1">
                        <img src="{{ url_for('static', filename='camera_icon_small.png') }}" alt="ถ่ายรูป">
                    </span>
                </div>
            </div>
            <div class="input-group">
                <label>รหัสที่ 2</label>
                <div class="input-wrapper">
                    <input type="text" placeholder="ช่องกรอกรหัสที่ 2" class="code-input">
                    <span class="icon camera-trigger" data-input="code-2">
                        <img src="{{ url_for('static', filename='camera_icon_small.png') }}" alt="ถ่ายรูป">
                    </span>
                </div>
            </div>
            <div class="input-group">
                <label>รหัสที่ 3</label>
                <div class="input-wrapper">
                    <input type="text" placeholder="ช่องกรอกรหัสที่ 3" class="code-input">
                    <span class="icon camera-trigger" data-input="code-3">
                        <img src="{{ url_for('static', filename='camera_icon_small.png') }}" alt="ถ่ายรูป">
                    </span>
                </div>
            </div>


            <button class="submit-button" disabled>กดเพื่อสะสมแต้มเอ็ม</button>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const cameraTriggers = document.querySelectorAll('.camera-trigger');
            const cameraModal = document.getElementById('camera-modal');
            const cameraView = document.getElementById('camera-view');
            const cameraCanvas = document.getElementById('camera-canvas');
            const captureBtn = document.getElementById('capture-btn');
            const closeCamera = document.getElementById('close-camera');
            let currentInput = null;
            let stream = null;

            // ตรวจสอบว่าเป็นมือถือหรือไม่
            function isMobile() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            }

            // เปิดกล้อง
            async function startCamera() {
                try {
                    const constraints = {
                        video: {
                            width: { ideal: 720 },
                            height: { ideal: 720 }, // ตั้งค่าความสูงเท่ากับความกว้าง
                            aspectRatio: 1, // กำหนดอัตราส่วน 1:1
                            facingMode: isMobile() ? { exact: "environment" } : "user"
                        }
                    };

                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    cameraView.srcObject = stream;

                    // ปรับขนาดให้พอดีกับ container
                    cameraView.onloadedmetadata = () => {
                        const container = document.querySelector('.camera-container');
                        const size = Math.min(container.offsetWidth, window.innerHeight * 0.7);
                        container.style.width = `${size}px`;
                        container.style.height = `${size}px`;
                    };

                    cameraModal.style.display = 'flex';
                } catch (err) {
                    console.error("Camera error: ", err);
                    alert("ไม่สามารถเปิดกล้องได้: " + err.message);
                    // แสดงวิธีแก้ไขให้ผู้ใช้
                    if (err.name === 'NotAllowedError') {
                        alert("กรุณาอนุญาตการเข้าถึงกล้องในหน้าต่างป๊อปอัป");
                    } else if (err.name === 'NotFoundError') {
                        alert("ไม่พบอุปกรณ์กล้องในระบบ");
                    }
                }
            }

            // ปิดกล้อง
            function stopCamera() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    cameraView.srcObject = null;
                    stream = null;
                }
                cameraModal.style.display = 'none';
            }

            // จับภาพจากกล้อง
            function captureImage() {
                const context = cameraCanvas.getContext('2d');
                cameraCanvas.width = cameraView.videoWidth;
                cameraCanvas.height = cameraView.videoHeight;
                context.drawImage(cameraView, 0, 0, cameraCanvas.width, cameraCanvas.height);

                // ここでOCR処理を呼び出すか、画像をサーバーに送信
                alert("ภาพถูกถ่ายแล้ว ระบบจะทำการประมวลผลรหัส");
                if (currentInput) {
                    // ตัวอย่างการใส่ค่าลงใน input (ควรเปลี่ยนเป็นผลลัพธ์จาก OCR จริง)
                    currentInput.value = "รหัสจากภาพ";
                }
                stopCamera();
            }

            // Event Listeners
            cameraTriggers.forEach(trigger => {
                trigger.addEventListener('click', function () {
                    currentInput = this.closest('.input-wrapper').querySelector('.code-input');
                    startCamera();
                });
            });

            captureBtn.addEventListener('click', captureImage);
            closeCamera.addEventListener('click', stopCamera);

            // ปิดกล้องเมื่อคลิกนอกพื้นที่
            cameraModal.addEventListener('click', function (e) {
                if (e.target === this) {
                    stopCamera();
                }
            });
        });

        // ฟังก์ชันอัพเดทแต้ม
        function updatePoints() {
            fetch('/get_points')
                .then(response => response.json())
                .then(data => {
                    const counter = document.getElementById('points-counter');
                    counter.textContent = data.formatted_count + ' แต้ม';

                    // เพิ่มเอฟเฟกต์เมื่ออัพเดท
                    counter.classList.add('updated');
                    setTimeout(() => {
                        counter.classList.remove('updated');
                    }, 300);

                    // เรียกฟังก์ชันตัวเองทุก 3 วินาที
                    setTimeout(updatePoints, 3000);
                })
                .catch(error => {
                    console.error('Error fetching points:', error);
                    setTimeout(updatePoints, 5000); // ลองใหม่ใน 5 วินาทีหากมีข้อผิดพลาด
                });
        }

        // เริ่มการอัพเดทเมื่อหน้าเว็บโหลดเสร็จ
        document.addEventListener('DOMContentLoaded', updatePoints);
    </script>

    <!-- เพิ่มส่วนนี้ก่อน </body> -->
    <div class="camera-modal" id="camera-modal">
        <div class="camera-container">
            <div class="camera-square">
                <video id="camera-view" autoplay playsinline></video>
            </div>
            <div class="camera-controls">
                <button id="close-camera">ปิด</button>
                <button id="capture-btn">ถ่ายภาพ</button>
            </div>
        </div>
        <canvas id="camera-canvas" style="display:none;"></canvas>
    </div>
</body>

</html>